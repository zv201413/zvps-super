name: Build and Push to GHCR

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æ„å»º

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ç¡®ä¿è„šæœ¬æƒé™å’Œæ–‡ä»¶å­˜åœ¨
      - name: Prepare environment
        run: |
          if [ ! -f "entrypoint.sh" ]; then
            echo "âŒ é”™è¯¯: æ ¹ç›®å½•ä¸‹æœªæ‰¾åˆ° entrypoint.sh"
            exit 1
          fi
          chmod +x entrypoint.sh
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"

      # 2. è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·
      - name: Set Image Tag
        id: vars
        run: |
          # ç”Ÿæˆæ ¼å¼ï¼š20260205-shortsha
          echo "tag=$(date +'%Y%m%d')-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # 3. ç™»å½•åˆ° GitHub Container Registry
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. æ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # åŠ¨æ€æ ‡ç­¾ï¼šlatest æ–¹ä¾¿å¿«é€Ÿæ›´æ–°ï¼Œæ—¥æœŸæ ‡ç­¾æ–¹ä¾¿ç‰ˆæœ¬å›æ»š
          tags: |
            ghcr.io/${{ github.repository_owner }}/zvps_test:latest
            ghcr.io/${{ github.repository_owner }}/zvps_test:${{ steps.vars.outputs.tag }}

      # 5. åœ¨æ§åˆ¶å°æ‰“å°æ„å»ºä¿¡æ¯
      - name: Image info
        run: |
          echo "ğŸ‰ é•œåƒæ„å»ºæˆåŠŸå¹¶å·²æ¨é€åˆ° GHCRï¼"
          echo "-------------------------------------"
          echo "æœ€æ–°æ ‡ç­¾: ghcr.io/${{ github.repository_owner }}/zvps_test:latest"
          echo "ç‰ˆæœ¬æ ‡ç­¾: ghcr.io/${{ github.repository_owner }}/zvps_test:${{ steps.vars.outputs.tag }}"
          echo "-------------------------------------"
